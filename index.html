<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Digital Inclusion Hubs â€“ Postcode Mapper (UK)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
    .wrap { display: flex; flex-direction: row; height: 100vh; }
    .panel {
      width: 360px; padding: 16px; overflow-y: auto;
      border-right: 1px solid #e6e6e6; background: #fafafa;
    }
    h1 { font-size: 16px; margin-bottom: 12px; }
    label { font-size: 12px; color: #444; display: block; margin: 10px 0 4px; }
    input, textarea, button {
      width: 100%; font-size: 14px; padding: 10px;
      border-radius: 10px; border: 1px solid #ccc; box-sizing: border-box;
    }
    textarea { min-height: 140px; }
    textarea:disabled { background: #f0f0f0; color: #888; }
    button {
      margin-top: 12px; background: #111; color: #fff;
      font-weight: 600; cursor: pointer;
    }
    .small { font-size: 12px; color: #666; margin-top: 4px; }
    .stats { font-size: 13px; margin-top: 12px; }
    .error { color: #b00020; font-size: 12px; white-space: pre-wrap; margin-top: 8px; }
    #map { flex: 1; }

    @media (max-width: 900px) {
      .wrap { flex-direction: column; }
      .panel { width: 100%; border-right: none; border-bottom: 1px solid #e6e6e6; }
      #map { height: 60vh; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="panel">
    <h1>Digital Inclusion Hub Mapper</h1>

    <label>Central postcode</label>
    <input id="centre" placeholder="E1 6AN" autocapitalize="characters">

    <label>Centre name (optional)</label>
    <input id="centreName" placeholder="e.g. Birmingham City Centre">

    <label>Hubs (manual entry)</label>
    <textarea id="hubs" placeholder="One per line:
Westminster Hub, SW1A 1AA
City Advice Centre, EC1A 1BB"></textarea>
    <div class="small">Format: <strong>Hub name, postcode</strong></div>

    <hr style="margin:12px 0;">

    <label>Or upload hubs CSV</label>
    <input type="file" id="hubFile" accept=".csv">
    <div class="small" id="csvStatus">
      CSV format: <strong>no headers</strong><br>
      Column A = hub name<br>
      Column B = postcode
    </div>

    <label>Radius (km)</label>
    <input id="radius" type="number" value="5" step="0.1" min="0.1">

    <button type="button" onclick="run()">Map hubs</button>

    <div class="stats">
      Inside radius: <span id="inCount">0</span><br>
      Outside radius: <span id="outCount">0</span><br>
      Total mapped: <span id="totalCount">0</span>
    </div>

    <div class="error" id="err"></div>
  </div>

  <div id="map"></div>
</div>

<script>
  // --- Map ---
  const map = L.map("map").setView([51.5074, -0.1278], 11);
  L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}" +
      (L.Browser.retina ? "@2x.png" : ".png"),
    { subdomains: "abcd", maxZoom: 20 }
  ).addTo(map);

  const layerGroup = L.layerGroup().addTo(map);
  let radiusCircle;

  function norm(pc) {
    return (pc || "").trim().toUpperCase().replace(/\s+/g, "");
  }

  const HUB_ICON = L.icon({
    iconUrl: "./gtf-logo.png",
    iconSize: [22, 22],
    iconAnchor: [11, 11]
  });

  function distanceKm(aLat, aLon, bLat, bLon) {
    const R = 6371;
    const dLat = (bLat - aLat) * Math.PI / 180;
    const dLon = (bLon - aLon) * Math.PI / 180;
    const lat1 = aLat * Math.PI / 180;
    const lat2 = bLat * Math.PI / 180;
    const h =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
    return 2 * R * Math.asin(Math.sqrt(h));
  }

  async function geocodeSingle(pc) {
    const r = await fetch("https://api.postcodes.io/postcodes/" + encodeURIComponent(pc));
    const j = await r.json();
    if (!j.result) throw new Error("Invalid centre postcode");
    return j.result;
  }

  async function geocodeBulk(list) {
    const r = await fetch("https://api.postcodes.io/postcodes", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ postcodes: list })
    });
    const j = await r.json();
    return j.result.filter(x => x.result).map(x => x.result);
  }

  function parseCSV(text) {
    return text.split(/\r?\n/).filter(Boolean).map((line, i) => {
      const cols = line.split(",").map(c => c.trim());
      if (cols.length < 2) throw new Error(`CSV error on line ${i + 1}`);
      return { name: cols[0], postcode: norm(cols[1]) };
    });
  }

  // Disable textarea when CSV chosen
  document.getElementById("hubFile").addEventListener("change", e => {
    const ta = document.getElementById("hubs");
    const status = document.getElementById("csvStatus");
    if (e.target.files.length) {
      ta.disabled = true;
      status.innerHTML = `<strong>Using CSV:</strong> ${e.target.files[0].name}`;
    } else {
      ta.disabled = false;
      status.innerHTML = `CSV format: <strong>no headers</strong><br>Column A = hub name<br>Column B = postcode`;
    }
  });

  async function run() {
    document.getElementById("err").textContent = "";
    layerGroup.clearLayers();
    if (radiusCircle) map.removeLayer(radiusCircle);

    try {
      const centrePc = norm(document.getElementById("centre").value);
      const centreName = document.getElementById("centreName").value.trim() || "Centre";
      const radiusKm = Number(document.getElementById("radius").value);

      let hubs = [];

      const fileInput = document.getElementById("hubFile");
      if (fileInput.files.length) {
        hubs = parseCSV(await fileInput.files[0].text());
      } else {
        hubs = document.getElementById("hubs").value
          .split(/\r?\n/)
          .filter(Boolean)
          .map((line, i) => {
            const parts = line.split(",").map(p => p.trim());
            if (parts.length < 2) throw new Error(`Manual entry error on line ${i + 1}`);
            return { name: parts[0], postcode: norm(parts[1]) };
          });
      }

      if (!centrePc || !hubs.length) throw new Error("Enter a centre and at least one hub.");

      const centre = await geocodeSingle(centrePc);
      const hubResults = await geocodeBulk(hubs.map(h => h.postcode));

      const cLatLng = [centre.latitude, centre.longitude];
      L.marker(cLatLng)
        .addTo(layerGroup)
        .bindTooltip(centreName, { direction: "top", offset: [0, -8] })
        .bindPopup(`<strong>${centreName}</strong>`);

      radiusCircle = L.circle(cLatLng, { radius: radiusKm * 1000, fill: false }).addTo(map);

      let inside = 0, outside = 0;
      const bounds = [cLatLng];

      hubResults.forEach((h, i) => {
        const meta = hubs[i];
        const d = distanceKm(centre.latitude, centre.longitude, h.latitude, h.longitude);
        if (d <= radiusKm) inside++; else outside++;

        const ll = [h.latitude, h.longitude];
        bounds.push(ll);

        const m = L.marker(ll, { icon: HUB_ICON }).addTo(layerGroup);
        m.bindTooltip(meta.name, { direction: "top", offset: [0, -6], sticky: true });
        m.bindPopup(`<strong>${meta.name}</strong>`);
      });

      map.fitBounds(bounds, { padding: [30, 30] });

      document.getElementById("inCount").textContent = inside;
      document.getElementById("outCount").textContent = outside;
      document.getElementById("totalCount").textContent = hubResults.length;

    } catch (e) {
      document.getElementById("err").textContent = e.message;
    }
  }
</script>
</body>
</html>
